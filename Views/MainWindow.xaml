<Window x:Class="FikusIn.Views.MainWindow"
        x:Name="wMain"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:scm="clr-namespace:System.ComponentModel;assembly=WindowsBase"
        xmlns:local="clr-namespace:FikusIn"
        xmlns:views="clr-namespace:FikusIn.Views"
        xmlns:conv="clr-namespace:FikusIn.UIConverters"
        xmlns:utils="clr-namespace:FikusIn.Utils"
        xmlns:properties="clr-namespace:FikusIn.Properties"
        mc:Ignorable="d"
        Title="FikusIn"
        Height="540"
        Width="960"
        WindowStyle="SingleBorderWindow"
        ResizeMode="CanResize"
        WindowState="Maximized"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource colorMainWindowBackground}"
        Loaded="wMain_Loaded">

    <Window.Resources>
        <Style x:Key="WindowsButtons"
               TargetType="{x:Type Button}">
            <Setter Property="VerticalAlignment"
                    Value="Top" />
            <Setter Property="HorizontalAlignment"
                    Value="Right" />
            <Setter Property="Margin"
                    Value="0,0,0,0" />
            <Setter Property="Width"
                    Value="46" />
            <Setter Property="Height"
                    Value="32" />
            <Setter Property="FontSize"
                    Value="32" />
            <Setter Property="FontWeight"
                    Value="Light" />
            <Setter Property="VerticalContentAlignment"
                    Value="Center" />
            <Setter Property="Opacity"
                    Value="0.5" />
            <Setter Property="BorderThickness"
                    Value="0" />
            <Setter Property="Background"
                    Value="Transparent" />
            <Setter Property="TextBlock.Foreground"
                    Value="{StaticResource colorWindowsButtonForeground}" />
            <Setter Property="TextBlock.Opacity"
                    Value="1" />
            <Setter Property="WindowChrome.IsHitTestVisibleInChrome"
                    Value="True" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver"
                         Value="True">
                    <Setter Property="Background"
                            Value="{StaticResource colorWindowsButtonMouseOnBackground}" />
                    <Setter Property="TextBlock.Foreground"
                            Value="{StaticResource colorWindowsButtonMouseOnForeground}" />
                    <Setter Property="Opacity"
                            Value="1" />
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="WindowsButtonsX"
               TargetType="{x:Type Button}"
               BasedOn="{StaticResource WindowsButtons}">
            <Style.Triggers>
                <Trigger Property="IsMouseOver"
                         Value="True">
                    <Setter Property="Background"
                            Value="{StaticResource colorWindowsButtonXMouseOnBackground}" />
                    <Setter Property="TextBlock.Foreground"
                            Value="{StaticResource colorWindowsButtonXMouseOnForeground}" />
                    <Setter Property="Opacity"
                            Value="1" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="AutoSizeTextBox"
               TargetType="{x:Type TextBlock}">
            <Setter Property="FontSize"
                    Value="18" />
            <Setter Property="MaxWidth"
                    Value="500" />
            <Setter Property="Margin"
                    Value="0,1,5,0" />
            <Style.Triggers>
                <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource Self}, Converter={x:Static conv:IsGreaterThanConverter.Instance}, ConverterParameter=150}"
                             Value="True">
                    <Setter Property="FontSize"
                            Value="14" />
                    <Setter Property="MaxWidth"
                            Value="200" />
                    <Setter Property="Margin"
                            Value="0,5,10,0" />
                    <Setter Property="ToolTip"
                            Value="{Binding Name}" />
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="TabCloseButton"
               TargetType="{x:Type Button}">
            <Setter Property="Background"
                    Value="Transparent" />
            <Setter Property="BorderThickness"
                    Value="0" />
            <Setter Property="Margin"
                    Value="0,0,5,0" />
            <Setter Property="TextBlock.Foreground"
                    Value="{StaticResource colorDocumentTabForeground}" />
            <Setter Property="Height"
                    Value="Auto" />
            <Setter Property="WindowChrome.IsHitTestVisibleInChrome"
                    Value="True" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver"
                         Value="True">
                    <Setter Property="TextBlock.Foreground"
                            Value="{StaticResource colorDocumentTabMouseOnForeground}" />
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="TabButtonStyle"
               TargetType="{x:Type Button}">
            <Setter Property="Tag"
                    Value="{Binding Id}" />
            <Setter Property="Background"
                    Value="{StaticResource colorDocumentTabBackground}" />
            <Setter Property="BorderThickness"
                    Value="0" />
            <Setter Property="Height"
                    Value="Auto" />
            <Setter Property="Margin"
                    Value="2,0,2,0" />
            <Setter Property="TextBlock.Foreground"
                    Value="{StaticResource colorDocumentTabForeground}" />
            <Setter Property="TextBlock.VerticalAlignment"
                    Value="Center" />
            <Setter Property="WindowChrome.IsHitTestVisibleInChrome"
                    Value="True" />
            <Setter Property="VerticalAlignment"
                    Value="Bottom" />
            <Setter Property="Command"
                    Value="{Binding ElementName=tabsItemsControl, Path=DataContext.SetActiveDocument}" />
            <Setter Property="CommandParameter"
                    Value="{Binding}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Border Background="{TemplateBinding Background}"
                                BorderThickness="0">
                            <StackPanel Orientation="Horizontal"
                                        Margin="10,0,0,0">
                                <TextBlock Text="✏️"
                                           FontSize="10"
                                           Margin="0,8,2,0">
                                    <TextBlock.Style>
                                        <Style TargetType="{x:Type TextBlock}">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsModified}"
                                                             Value="False">
                                                    <Setter Property="Visibility"
                                                            Value="Collapsed" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <TextBlock Height="23"
                                           Text="{Binding Name}"
                                           TextTrimming="CharacterEllipsis"
                                           Style="{StaticResource AutoSizeTextBox}" />
                                <Button Style="{StaticResource TabCloseButton}"
                                        Command="{Binding ElementName=tabsItemsControl, Path=DataContext.CloseDocument}"
                                        CommandParameter="{Binding}"
                                        Margin="0,0,1,1">
                                    <TextBlock FontSize="16"
                                               Text="❎" />
                                </Button>
                            </StackPanel>
                        </Border>
                        <ControlTemplate.Triggers>
                            <DataTrigger Binding="{Binding IsActive}"
                                         Value="True">
                                <Setter Property="Background"
                                        Value="{StaticResource colorActiveDocumentTabBackground}" />
                                <Setter Property="TextBlock.Foreground"
                                        Value="{StaticResource colorActiveDocumentTabForeground}" />
                                <Setter Property="utils:FocusBehavior.IsFocus"
                                        Value="True" />
                            </DataTrigger>
                            <Trigger Property="IsMouseOver"
                                     Value="True">
                                <Setter Property="TextBlock.Foreground"
                                        Value="{StaticResource colorDocumentTabMouseOnForeground}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="FileToolbarButton"
               TargetType="{x:Type Button}">
            <Setter Property="BorderThickness"
                    Value="0" />
            <Setter Property="Background"
                    Value="Transparent" />
            <Setter Property="TextBlock.Foreground"
                    Value="{StaticResource colorFileToolbarButtonForeground}" />
            <Setter Property="TextBlock.FontSize"
                    Value="20" />
            <Setter Property="TextBlock.FontFamily"
                    Value="Consolas" />
            <Setter Property="WindowChrome.IsHitTestVisibleInChrome"
                    Value="True" />
            <Setter Property="Margin"
                    Value="0" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver"
                         Value="True">
                    <Setter Property="Background"
                            Value="{StaticResource colorFileToolbarButtonMouseOnBackground}" />
                    <Setter Property="TextBlock.Foreground"
                            Value="{StaticResource colorFileToolbarButtonMouseOnForeground}" />
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="FileToolbarToggleButton"
               TargetType="{x:Type ToggleButton}">
            <Setter Property="BorderThickness"
                    Value="0" />
            <Setter Property="Background"
                    Value="Transparent" />
            <Setter Property="TextBlock.Foreground"
                    Value="{StaticResource colorFileToolbarButtonForeground}" />
            <Setter Property="TextBlock.FontSize"
                    Value="20" />
            <Setter Property="TextBlock.FontFamily"
                    Value="Consolas" />
            <Setter Property="WindowChrome.IsHitTestVisibleInChrome"
                    Value="True" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ToggleButton}">
                        <Border x:Name="border"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Background="{TemplateBinding Background}"
                                SnapsToDevicePixels="True">
                            <ContentPresenter x:Name="contentPresenter"
                                              ContentTemplate="{TemplateBinding ContentTemplate}"
                                              Content="{TemplateBinding Content}"
                                              ContentStringFormat="{TemplateBinding ContentStringFormat}"
                                              Focusable="False"
                                              HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              Margin="{TemplateBinding Padding}"
                                              RecognizesAccessKey="True"
                                              SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver"
                         Value="True">
                    <Setter Property="Background"
                            Value="{StaticResource colorFileToolbarButtonMouseOnBackground}" />
                    <Setter Property="TextBlock.Foreground"
                            Value="{StaticResource colorFileToolbarButtonMouseOnForeground}" />
                </Trigger>
                <Trigger Property="IsChecked"
                         Value="True">
                    <Setter Property="Background"
                            Value="{StaticResource colorFileToolbarButtonMouseOnBackground}" />
                    <Setter Property="TextBlock.Foreground"
                            Value="{StaticResource colorFileToolbarButtonMouseOnForeground}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="DocumentListMenuButton"
               TargetType="{x:Type Button}">
            <Setter Property="Tag"
                    Value="{Binding Id}" />
            <Setter Property="BorderThickness"
                    Value="0" />
            <Setter Property="Background"
                    Value="#333333" />
            <Setter Property="TextBlock.Foreground"
                    Value="#BBBBBB" />
            <Setter Property="TextBlock.FontSize"
                    Value="18" />
            <Setter Property="TextBlock.FontFamily"
                    Value="Consolas" />
            <Setter Property="HorizontalAlignment"
                    Value="Left" />
            <Setter Property="VerticalAlignment"
                    Value="Center" />
            <Setter Property="WindowChrome.IsHitTestVisibleInChrome"
                    Value="True" />
            <Setter Property="Margin"
                    Value="0" />
            <Setter Property="MinWidth"
                    Value="150" />
            <Setter Property="Command"
                    Value="{Binding ElementName=icDocumentsList, 
                Path=DataContext.SetActiveDocument}" />
            <Setter Property="CommandParameter"
                    Value="{Binding}" />
            <Setter Property="Content"
                    Value="{Binding Name}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Grid>
                            <Border Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition SharedSizeGroup="shsgDocumentListPopup" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding Name}"
                                               Margin="21,2,10,4" />
                                </Grid>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver"
                         Value="True">
                    <Setter Property="Background"
                            Value="#BBBBBB" />
                    <Setter Property="TextBlock.Foreground"
                            Value="#444444" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="PopupMenuButton"
               TargetType="{x:Type Button}">
            <Setter Property="BorderThickness"
                    Value="0" />
            <Setter Property="Background"
                    Value="{StaticResource colorPopupMenuButtonBackground}" />
            <Setter Property="TextBlock.Foreground"
                    Value="{StaticResource colorPopupMenuButtonForeground}" />
            <Setter Property="TextBlock.FontSize"
                    Value="18" />
            <Setter Property="TextBlock.FontFamily"
                    Value="Consolas" />
            <Setter Property="HorizontalAlignment"
                    Value="Left" />
            <Setter Property="VerticalAlignment"
                    Value="Center" />
            <Setter Property="WindowChrome.IsHitTestVisibleInChrome"
                    Value="True" />
            <Setter Property="Margin"
                    Value="0" />
            <Setter Property="MinWidth"
                    Value="150" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Grid>
                            <Border Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition SharedSizeGroup="shsgDocumentListPopup" />
                                    </Grid.ColumnDefinitions>
                                    <ContentPresenter HorizontalAlignment="Left"
                                                      VerticalAlignment="Center"
                                                      Margin="21,2,10,4" />
                                </Grid>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver"
                         Value="True">
                    <Setter Property="Background"
                            Value="{StaticResource colorPopupMenuButtonMouseOnBackground}" />
                    <Setter Property="TextBlock.Foreground"
                            Value="{StaticResource colorPopupMenuButtonMouseOnForeground}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <CollectionViewSource x:Key="SortedDocuments"
                              Source="{Binding Documents}">
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="Name"
                                     Direction="Ascending" />
            </CollectionViewSource.SortDescriptions>
        </CollectionViewSource>
    </Window.Resources>

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="32"
                      ResizeBorderThickness="4"
                      GlassFrameThickness="1" />
    </WindowChrome.WindowChrome>

    <Window.InputBindings>
        <KeyBinding Command="{Binding NewDocument}"
                    Modifiers="Ctrl"
                    Key="N" />
        <KeyBinding Command="{Binding OpenDocument}"
                    Modifiers="Ctrl"
                    Key="O" />
        <KeyBinding Command="{Binding SaveDocument}"
                    Modifiers="Ctrl"
                    Key="S" />
        <KeyBinding Command="{Binding SaveDocumentAs}"
                    Modifiers="Ctrl+Shift"
                    Key="S" />
        <KeyBinding Command="{Binding SaveAllDocuments}"
                    Modifiers="Ctrl+Shift+Alt"
                    Key="S" />
    </Window.InputBindings>

    <Border Background="{StaticResource colorMainWindowBackground}">
        <Border.Style>
            <Style TargetType="{x:Type Border}">
                <Style.Triggers>
                    <!-- Add to avoid border disappearing when window is maximised -->
                    <DataTrigger Binding="{Binding WindowState, RelativeSource={RelativeSource AncestorType=Window}}"
                                 Value="Maximized">
                        <Setter Property="Margin"
                                Value="8" />
                    </DataTrigger>
                    <DataTrigger Binding="{Binding WindowState, RelativeSource={RelativeSource AncestorType=Window}}"
                                 Value="Normal">
                        <Setter Property="Margin"
                                Value="0" />
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>

        <Grid Background="{StaticResource colorMainWindowBackground}"
              Margin="0">
            <Grid.LayoutTransform>
                <ScaleTransform ScaleX="{Binding WindowScale}"
                                ScaleY="{Binding WindowScale}"
                                CenterX=".5"
                                CenterY=".5" />
            </Grid.LayoutTransform>
            <Grid.RowDefinitions>
                <RowDefinition Height="26" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Top window bar (file menu + doc tabs + window operation-->
            <DockPanel x:Name="pnlTop"
                       HorizontalAlignment="Stretch"
                       VerticalAlignment="Top"
                       Height="Auto"
                       Width="Auto"
                       Background="#444444"
                       Grid.Row="0"
                       Margin="0">
                <Grid HorizontalAlignment="Stretch"
                      Margin="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="auto" />
                    </Grid.ColumnDefinitions>

                    <!--File menu-->
                    <StackPanel Height="Auto"
                                Width="Auto"
                                Background="Transparent"
                                Orientation="Horizontal"
                                Margin="0,0,0,0"
                                Grid.Column="0">
                        <TextBlock Text="🌿"
                                   FontSize="20"
                                   Foreground="Green" />
                        <Button x:Name="btnNewDoc"
                                Style="{StaticResource FileToolbarButton}"
                                ToolTip="New&#x0a;Ctrl+N"
                                Command="{Binding NewDocument}">
                            <TextBlock Text="📄"
                                       Margin="0,1,0,0" />
                        </Button>
                        <Button x:Name="btnOpenDoc"
                                ToolTip="Open&#x0a;Ctrl+O"
                                Command="{Binding OpenDocument}">
                            <Button.Style>
                                <Style TargetType="Button"
                                       BasedOn="{StaticResource FileToolbarButton}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ElementName=btnOpenDoc2,
                                                   Path=IsMouseOver}"
                                                     Value="True">
                                            <Setter Property="Background"
                                                    Value="{StaticResource colorFileToolbarButtonPartnerMouseOnBackground}" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsChecked, ElementName=btnOpenDoc2}"
                                                     Value="True">
                                            <Setter Property="Background"
                                                    Value="{StaticResource colorFileToolbarButtonPartnerMouseOnBackground}" />
                                        </DataTrigger>

                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <TextBlock Text="📂"
                                       Margin="0,0,0,0" />
                        </Button>
                        <ToggleButton x:Name="btnOpenDoc2"
                                      IsHitTestVisible="{Binding ElementName=popupOpen, 
                                        Path=IsOpen, 
                                        Mode=OneWay, Converter={conv:BoolInverter}}"
                                      Grid.Column="1">
                            <ToggleButton.Style>
                                <Style TargetType="{x:Type ToggleButton}"
                                       BasedOn="{StaticResource FileToolbarToggleButton}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ElementName=btnOpenDoc,
                                                   Path=IsMouseOver}"
                                                     Value="True">
                                            <Setter Property="Background"
                                                    Value="{StaticResource colorFileToolbarButtonPartnerMouseOnBackground}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ToggleButton.Style>
                            <StackPanel Margin="0">
                                <TextBlock Text="🔻"
                                           Margin="0,10,0,0"
                                           FontSize="14" />
                                <Popup x:Name="popupOpen"
                                       IsOpen="{Binding IsChecked, ElementName=btnOpenDoc2}"
                                       StaysOpen="False"
                                       AllowsTransparency="True">
                                    <Border BorderThickness="0.5"
                                            CornerRadius="0"
                                            Background="#333333"
                                            BorderBrush="#BBBBBB"
                                            Margin="0">
                                        <ScrollViewer MaxHeight="{Binding ActualHeight, ElementName=gridGraphicMain}"
                                                      MaxWidth="600"
                                                      HorizontalScrollBarVisibility="Auto"
                                                      VerticalScrollBarVisibility="Auto">
                                            <StackPanel Margin="0"
                                                        VerticalAlignment="Center"
                                                        HorizontalAlignment="Left"
                                                        Orientation="Vertical"
                                                        Grid.IsSharedSizeScope="True">
                                            </StackPanel>
                                        </ScrollViewer>
                                    </Border>
                                </Popup>
                            </StackPanel>
                        </ToggleButton>
                        <Button x:Name="btnSaveDoc"
                                ToolTip="Save&#x0a;Ctrl+S"
                                Command="{Binding SaveDocument}">
                            <Button.Style>
                                <Style TargetType="Button"
                                       BasedOn="{StaticResource FileToolbarButton}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ElementName=btnSaveDoc2,
                                                   Path=IsMouseOver}"
                                                     Value="True">
                                            <Setter Property="Background"
                                                    Value="{StaticResource colorFileToolbarButtonPartnerMouseOnBackground}" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsChecked, ElementName=btnSaveDoc2}"
                                                     Value="True">
                                            <Setter Property="Background"
                                                    Value="{StaticResource colorFileToolbarButtonPartnerMouseOnBackground}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <TextBlock Text="💾"
                                       Margin="0,1,0,0" />
                        </Button>
                        <ToggleButton x:Name="btnSaveDoc2"
                                      IsHitTestVisible="{Binding ElementName=popupSave, 
                                        Path=IsOpen, 
                                        Mode=OneWay, Converter={conv:BoolInverter}}"
                                      Grid.Column="1">
                            <ToggleButton.Style>
                                <Style TargetType="{x:Type ToggleButton}"
                                       BasedOn="{StaticResource FileToolbarToggleButton}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ElementName=btnSaveDoc,
                                                   Path=IsMouseOver}"
                                                     Value="True">
                                            <Setter Property="Background"
                                                    Value="{StaticResource colorFileToolbarButtonPartnerMouseOnBackground}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ToggleButton.Style>
                            <StackPanel Margin="0">
                                <TextBlock Text="🔻"
                                           Margin="0,10,0,0"
                                           FontSize="14" />
                                <Popup x:Name="popupSave"
                                       IsOpen="{Binding IsChecked, ElementName=btnSaveDoc2}"
                                       StaysOpen="False"
                                       AllowsTransparency="True">
                                    <Border BorderThickness="0.5"
                                            CornerRadius="0"
                                            Background="#333333"
                                            BorderBrush="#BBBBBB"
                                            Margin="0">
                                        <ScrollViewer MaxHeight="{Binding ActualHeight, ElementName=gridGraphicMain}"
                                                      MaxWidth="600"
                                                      HorizontalScrollBarVisibility="Auto"
                                                      VerticalScrollBarVisibility="Auto">
                                            <StackPanel Margin="0"
                                                        VerticalAlignment="Center"
                                                        HorizontalAlignment="Left"
                                                        Orientation="Vertical"
                                                        Grid.IsSharedSizeScope="True">
                                                <Button ToolTip="Save As...&#x0a;Ctrl+Shift+S"
                                                        Style="{StaticResource PopupMenuButton}"
                                                        Command="{Binding SaveDocumentAs}"
                                                        Click="popupSaveButton_Click">
                                                    <TextBlock Text="Save As..."
                                                               Margin="0,1,0,0" />
                                                </Button>
                                                <Button ToolTip="Save All&#x0a;Ctrl+Shift+Alt+S"
                                                        Style="{StaticResource PopupMenuButton}"
                                                        Command="{Binding SaveAllDocuments}"
                                                        Click="popupSaveButton_Click">
                                                    <TextBlock Text="Save All"
                                                               Margin="0,1,0,0" />
                                                </Button>
                                            </StackPanel>
                                        </ScrollViewer>
                                    </Border>
                                </Popup>
                            </StackPanel>
                        </ToggleButton>
                        <ToggleButton x:Name="tbtnSettings"
                                      Style="{StaticResource FileToolbarToggleButton}"
                                      IsHitTestVisible="{Binding ElementName=popupSettings, 
                                        Path=IsOpen, 
                                        Mode=OneWay, Converter={conv:BoolInverter}}"
                                      Grid.Column="1">
                            <StackPanel Margin="0">
                                <TextBlock Text="⚙️" />
                                <Popup x:Name="popupSettings"
                                       IsOpen="{Binding IsChecked, ElementName=tbtnSettings}"
                                       StaysOpen="False"
                                       AllowsTransparency="True">
                                    <Border BorderThickness="0.5"
                                            CornerRadius="0"
                                            Background="#333333"
                                            BorderBrush="#BBBBBB"
                                            Margin="0">
                                        <ScrollViewer MaxHeight="{Binding ActualHeight, ElementName=gridGraphicMain}"
                                                      MaxWidth="600"
                                                      HorizontalScrollBarVisibility="Auto"
                                                      VerticalScrollBarVisibility="Auto">
                                            <UniformGrid Columns="4">
                                                <Button ToolTip="Window Scale: Small"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Bottom"
                                                        Command="{Binding SetSmallZoomFactor}"
                                                        Width="28"
                                                        Height="28"
                                                        Click="popupSettingsButton_Click">
                                                    <Button.Style>
                                                        <Style TargetType="Button"
                                                               BasedOn="{StaticResource FileToolbarButton}">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding WindowScale}"
                                                                             Value="1">
                                                                    <Setter Property="Background"
                                                                            Value="#BBBBBB" />
                                                                    <Setter Property="TextBlock.Foreground"
                                                                            Value="#444444" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                    <TextBlock Text="🗚"
                                                               Margin="0,0,0,0"
                                                               FontSize="10" />
                                                </Button>
                                                <Button ToolTip="Window Scale: Medium"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Bottom"
                                                        Command="{Binding SetMidZoomFactor}"
                                                        Width="28"
                                                        Height="28"
                                                        Click="popupSettingsButton_Click">
                                                    <Button.Style>
                                                        <Style TargetType="Button"
                                                               BasedOn="{StaticResource FileToolbarButton}">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding WindowScale}"
                                                                             Value="1.2">
                                                                    <Setter Property="Background"
                                                                            Value="#BBBBBB" />
                                                                    <Setter Property="TextBlock.Foreground"
                                                                            Value="#444444" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                    <TextBlock Text="🗚"
                                                               Margin="0,0,0,0"
                                                               FontSize="12" />
                                                </Button>
                                                <Button ToolTip="Window Scale: Big"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Bottom"
                                                        Command="{Binding SetBigZoomFactor}"
                                                        Width="28"
                                                        Height="28"
                                                        Click="popupSettingsButton_Click">
                                                    <Button.Style>
                                                        <Style TargetType="Button"
                                                               BasedOn="{StaticResource FileToolbarButton}">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding WindowScale}"
                                                                             Value="1.5">
                                                                    <Setter Property="Background"
                                                                            Value="#BBBBBB" />
                                                                    <Setter Property="TextBlock.Foreground"
                                                                            Value="#444444" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                    <TextBlock Text="🗚"
                                                               Margin="0,0,0,0"
                                                               FontSize="15" />
                                                </Button>
                                                <Button ToolTip="Window Scale: Huge"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Bottom"
                                                        Command="{Binding SetHugeZoomFactor}"
                                                        Width="28"
                                                        Height="28"
                                                        Click="popupSettingsButton_Click">
                                                    <Button.Style>
                                                        <Style TargetType="Button"
                                                               BasedOn="{StaticResource FileToolbarButton}">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding WindowScale}"
                                                                             Value="2">
                                                                    <Setter Property="Background"
                                                                            Value="#BBBBBB" />
                                                                    <Setter Property="TextBlock.Foreground"
                                                                            Value="#444444" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                    <TextBlock Text="🗚"
                                                               Margin="0,0,0,0"
                                                               FontSize="20" />
                                                </Button>
                                                <Button ToolTip="Wireframe"
                                                        Command="{Binding ToggleWireframe}"
                                                        Click="popupSettingsButton_Click">
                                                    <Button.Style>
                                                        <Style TargetType="Button"
                                                               BasedOn="{StaticResource FileToolbarButton}">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Wireframe}"
                                                                             Value="True">
                                                                    <Setter Property="Background"
                                                                            Value="#BBBBBB" />
                                                                    <Setter Property="TextBlock.Foreground"
                                                                            Value="#444444" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                    <TextBlock Text="➿"
                                                               Margin="0,1,0,0" />
                                                </Button>
                                            </UniformGrid>
                                        </ScrollViewer>
                                    </Border>
                                </Popup>
                            </StackPanel>
                        </ToggleButton>
                    </StackPanel>

                    <!--Document tabs-->
                    <Grid Margin="0"
                          Grid.Column="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!--Actual list of document tabs-->
                        <Grid x:Name="grdDocumentTabs"
                              utils:ScrollViewerHelper.WheelScrollsHorizontally="True"
                              Margin="0"
                              Grid.Column="0">
                            <ScrollViewer x:Name="tabsScrollViewer"
                                          HorizontalScrollBarVisibility="Hidden"
                                          VerticalScrollBarVisibility="Hidden"
                                          CanContentScroll="True"
                                          BorderThickness="0"
                                          Margin="0">
                                <Grid DockPanel.Dock="Left"
                                      Height="Auto"
                                      Width="Auto"
                                      Margin="0,0,0,0"
                                      VerticalAlignment="Bottom"
                                      HorizontalAlignment="Left">
                                    <ItemsControl x:Name="tabsItemsControl"
                                                  ItemsSource="{Binding Documents}"
                                                  Margin="0">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel Height="Auto"
                                                            Width="Auto"
                                                            Margin="0,2,0,0"
                                                            VerticalAlignment="Bottom"
                                                            HorizontalAlignment="Left"
                                                            Orientation="Horizontal" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Button Style="{StaticResource TabButtonStyle}">
                                                    <Button.Resources>
                                                        <Style TargetType="{x:Type Border}">
                                                            <Setter Property="CornerRadius"
                                                                    Value="5,5,0,0" />
                                                            <Setter Property="BorderThickness"
                                                                    Value="0" />
                                                        </Style>
                                                    </Button.Resources>
                                                </Button>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Grid>
                            </ScrollViewer>
                        </Grid>

                        <!--Tab list button and popup-->
                        <ToggleButton x:Name="tbtnDocumentList"
                                      Style="{StaticResource FileToolbarToggleButton}"
                                      IsHitTestVisible="{Binding ElementName=popupDocumentList, 
                                        Path=IsOpen, 
                                        Mode=OneWay, Converter={conv:BoolInverter}}"
                                      Grid.Column="1">
                            <StackPanel Margin="0">
                                <StackPanel.Style>
                                    <Style TargetType="{x:Type StackPanel}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ElementName=tabsScrollViewer, Path=ScrollableWidth}"
                                                         Value="0">
                                                <Setter Property="Visibility"
                                                        Value="Collapsed" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>
                                <TextBlock Text="🔻" />
                                <Popup x:Name="popupDocumentList"
                                       IsOpen="{Binding IsChecked, ElementName=tbtnDocumentList}"
                                       StaysOpen="False"
                                       AllowsTransparency="True">
                                    <Border BorderThickness="0.5"
                                            CornerRadius="0"
                                            Background="#333333"
                                            BorderBrush="#BBBBBB"
                                            Margin="0">
                                        <ScrollViewer MaxHeight="{Binding ActualHeight, ElementName=gridGraphicMain}"
                                                      MaxWidth="600"
                                                      HorizontalScrollBarVisibility="Auto"
                                                      VerticalScrollBarVisibility="Auto">
                                            <ItemsControl x:Name="icDocumentsList"
                                                          ItemsSource="{Binding Documents}"
                                                          Margin="0">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel Margin="0"
                                                                    VerticalAlignment="Center"
                                                                    HorizontalAlignment="Left"
                                                                    Orientation="Vertical"
                                                                    Grid.IsSharedSizeScope="True" />
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Button Style="{StaticResource DocumentListMenuButton}"
                                                                Click="popupDocumentListButton_Click" />
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Border>
                                </Popup>
                            </StackPanel>
                        </ToggleButton>
                    </Grid>

                    <!--Right menu + window menu-->
                    <StackPanel x:Name="pnlTopRight"
                                Margin="0"
                                VerticalAlignment="Top"
                                HorizontalAlignment="Right"
                                Height="Auto"
                                Width="Auto"
                                Orientation="Horizontal"
                                Visibility="Visible"
                                DockPanel.Dock="Right"
                                Grid.Column="2">
                        <StackPanel Orientation="Horizontal"
                                    Margin="50,0,0,0">
                            <Button x:Name="btnMinimize"
                                    Style="{StaticResource WindowsButtons}"
                                    Margin="0,0,0,0"
                                    Click="btnMinimize_Click">
                                <TextBlock Text="_"
                                           Margin="0,-25,0,0" />
                            </Button>
                            <Button x:Name="btnMaximize"
                                    Style="{StaticResource WindowsButtons}"
                                    Margin="0,0,0,0"
                                    Click="btnMaximize_Click">
                                <TextBlock Text="□"
                                           Margin="0,-14,0,0" />
                            </Button>
                            <Button x:Name="btnClose"
                                    Style="{StaticResource WindowsButtonsX}"
                                    Click="btnClose_Click"
                                    Margin="0">
                                <TextBlock Text="×"
                                           Margin="0,-11,0,0" />
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </DockPanel>

            <!--Main area-->
            <Grid x:Name="gridGraphicMain"
                  Background="{StaticResource colorMainWindowBackground}"
                  Grid.Row="1"
                  Margin="0">

                <!--Document windows-->
                <ItemsControl x:Name="docsGfxItemsControl"
                              ItemsSource="{Binding Documents}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Grid Margin="0">
                            </Grid>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0"
                                  Background="{StaticResource colorMainWindowBackground}">
                                <Grid.Style>
                                    <Style TargetType="{x:Type Grid}">
                                        <Setter Property="Visibility"
                                                Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsActive}"
                                                         Value="True">
                                                <Setter Property="Visibility"
                                                        Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Grid.Style>
                                <views:DocumentWindow />
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!--Bottom: Message & Progressbars-->
                <Grid HorizontalAlignment="Stretch"
                      VerticalAlignment="Bottom"
                      Margin="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="auto" />
                    </Grid.RowDefinitions>
                    <Label x:Name="messageLabel"
                           FontSize="24"
                           FontFamily="Calibri"
                           HorizontalAlignment="Stretch"
                           VerticalAlignment="Bottom"
                           HorizontalContentAlignment="Center"
                           Content="{Binding Message}"
                           Foreground="{Binding MessageForeground}"
                           Background="{Binding MessageBackground}"
                           Grid.Row="0"
                           BorderThickness="0"
                           Margin="0">
                        <Label.Style>
                            <Style TargetType="Label">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ShowMessage}"
                                                 Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                     To="1"
                                                                     Duration="0:0:0.200" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.EnterActions>
                                        <DataTrigger.ExitActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                     To="0.05"
                                                                     Duration="0:0:0.500" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.ExitActions>
                                    </DataTrigger>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding ShowMessage}"
                                                       Value="False" />
                                            <Condition Binding="{Binding RelativeSource={RelativeSource Self}, Path=IsMouseOver}"
                                                       Value="True" />
                                        </MultiDataTrigger.Conditions>
                                        <MultiDataTrigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                     To="1"
                                                                     Duration="0:0:0.200" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </MultiDataTrigger.EnterActions>
                                        <MultiDataTrigger.ExitActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                     To="0.05"
                                                                     Duration="0:0:0.500" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </MultiDataTrigger.ExitActions>
                                    </MultiDataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Label.Style>
                    </Label>
                    <StackPanel HorizontalAlignment="Stretch"
                                VerticalAlignment="Bottom"
                                Orientation="Vertical"
                                Grid.Row="1"
                                Margin="0">
                        <ItemsControl ItemsSource="{Binding ProgressList}"
                                      BorderThickness="0">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <ProgressBar Minimum="{Binding Minimum}"
                                                 Maximum="{Binding Maximum}"
                                                 Value="{Binding Current}"
                                                 IsIndeterminate="{Binding IsIndeterminate}"
                                                 BorderThickness="0"
                                                 Height="3"
                                                 Grid.Row="1"
                                                 Background="#000000"
                                                 Foreground="#FFFFFF"
                                                 Margin="0" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Grid>

            </Grid>
        </Grid>
    </Border>
</Window>
